---
layout:     post
title:      Spring Boot에 Rest API 설계에 맞는 코드 작성하기
author:     Soo-young Hwang
tags: 		Spring-Boot Rest-API 
subtitle:  	
category:   project1
---

# Spring Boot에 Rest API 설계에 맞는 컨트롤러 작성하기

### 목표
- 서버에서 응답 코드랑 코드랑 매칭되는 응답 메시지로 `reponse` 처리하기
- REST API 구조 이해하기, 용도에 맞게 써 보려고 노력하기

### 참고 사이트
- `HttpRequest` `Response` 코드   
    [HttpStatus (Spring Framework 5.3.7 API)](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/http/HttpStatus.html#UNPROCESSABLE_ENTITY)

- `response`  구조 재설계   
    기존 : code 와 data 만 썼기에 내부적으로 에러 코드와 메시지를 전달할 수 없었음    
    [design-pattern-to-model-request-and-response-objects-for-webservices](https://stackoverflow.com/questions/26788608/design-pattern-to-model-request-and-response-objects-for-webservices)

    ![REST%20API%2080750e10cc4a4e5aa9e4b18fad4068c8/Untitled.png](https://swimmingHwang.github.io/img/restapi.png)

    ![REST%20API%2080750e10cc4a4e5aa9e4b18fad4068c8/Untitled%201.png](https://swimmingHwang.github.io/img/restapi1.png)

    위의 메시지의 경우 코드랑 response code를 일일히 입력해서 두개가 매핑이 따로 없었다. 
    자체적인 에러 코드를 재사용하기 위해 Enum을 이용했다.

<blockquote> 1. essage랑 response 코드 매핑해서 사용하고 싶어서 enum 사용하기 </blockquote>

[how-to-use-enum-effectively-in-java](https://www.developer.com/design/how-to-use-enum-effectively-in-java/)

- 커스텀 `Response` Class
```java
import lombok.Builder;
import lombok.Getter;
import lombok.Setter;
import org.springframework.http.HttpStatus;

@Getter
@Setter
@Builder(builderMethodName = "commonResponseBuilder")
public class CommonResponse<T> {

  private HttpStatus status;
  private String message;
  private int responseCode;
  private T data;

  public static CommonResponseBuilder<Object> builder(HttpStatus status){
    if(status == null){
      throw new IllegalArgumentException("Common Response Builder must have 'status' parameter");
    }
    return commonResponseBuilder().status(status);
  }
}
```

- Enum을 활용한 코드 정의 클래스
```java
@Getter
public enum CommonResponseCode implements EnumMapper {
    SUCCESS(200, "요청 처리에 성공했습니다."),
    INTERNAL_SERVER_ERROR(500, "서버 에러가 발생했습니다."),
    DUPLICATE_DATA(401, "중복 데이터가 존재합니다.");

    int code;
    String message;

    CommonResponseCode(int code, String message) {
    this.code = code;
    this.message = message;
    }
}
```
- EnumMapper
```java
public interface EnumMapper {
    int getCode();
    String getMessage();
}
```
- service 코드
```java
if (sendNumberList.stream().anyMatch(o -> o.getSendNumber().equals(dto.getSendNumber()))){
  **return CommonResponse.builder(HttpStatus.UNPROCESSABLE_ENTITY)
      .message(CommonResponseCode.DUPLICATE_DATA.getMessage())
      .responseCode(CommonResponseCode.DUPLICATE_DATA.getCode())
      .data(dto.getSendNumber())
      .build();**
}
```
- controller 코드
```java
@PostMapping
ResponseEntity<?> create(SendNumberDto dto) {
    CommonResponse<?> response = sendNumberService.registerSendNumberRequest(dto);
    return new ResponseEntity<>(response, response.getStatus());
}
```

```javascript

save () {
  const isValid = this.$refs.form.validate() // validation check
  let formData = serialize(this.sendNumber)

  if(isValid && this.sendNumber.memberId){
    if(confirm('등록하시겠습니까?')){
      this.$axios.post('/api/send-number',formData , {
        headers:{
            'Authorization' : `Bearer ${JSON.parse(localStorage.getItem('user')).accessToken}`,
            'Content-Type': "multipart/form-data",
            contentType: false, 
            processData: false,
          }
        })
      .then((response) => {
          alert("발신번호 승인 요청 되었습니다.")
          this.$router.push('/send-number/manage')
      })
      .catch((error) => {
          alert(error.response.data.message) //중복 데이터가 존재합니다.
          console.error("failed save sendnumber", res)
      })
    } 
  }else{
    alert("필수값을 입력해 주세요")
  }
}
```

- 결과 script console로 찍어보기

#### axios 응답 스키마
```json
{
  // `data`는 서버가 제공한 응답(데이터)입니다.
  data: {},

  // `status`는 서버 응답의 HTTP 상태 코드입니다.
  status: 200,

  // `statusText`는 서버 응답으로 부터의 HTTP 상태 메시지입니다.
  statusText: 'OK',

  // `headers` 서버가 응답 한 헤더는 모든 헤더 이름이 소문자로 제공됩니다.
  headers: {},

  // `config`는 요청에 대해 `axios`에 설정된 구성(config)입니다.
  config: {},

  // `request`는 응답을 생성한 요청입니다.
  // 브라우저: XMLHttpRequest 인스턴스
  // Node.js: ClientRequest 인스턴스(리디렉션)
  request: {}
}
```

출처 : [response-schema](https://xn--xy1bk56a.run/axios/guide/response-schema.html)

- 에러는 error.response안에 커스텀한 Reponse 데이터들이 들어가있다.
- request error catch시 `error.reponse` 를 콘솔 로그에 찍은 결과
    ![REST%20API%2080750e10cc4a4e5aa9e4b18fad4068c8/Untitled%202.png](https://swimmingHwang.github.io/img/restapi2.png)
- error 만 찍으면
    ![REST%20API%2080750e10cc4a4e5aa9e4b18fad4068c8/Untitled%203.png](https://swimmingHwang.github.io/img/restapi3.png)

### 기타

- [빌더 필수값 설정](https://zorba91.tistory.com/298) 

